<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    .content {
      max-width: 30em;
    }

    .container {
      display: grid;
      grid-template-columns: 35% 65%;
    }

    tr {
      text-align: left;
    }
  
    tr.center {
      text-align: center;
    }

    table {
      padding-top: 1em;
      border-spacing: 1em 0;
      border-collapse: separate;
    }

    td {
      padding: 0.5em 0;
    }

    .bold {
      font-weight: bold;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/styles/default.min.css">
  <script src="https://unpkg.com/@highlightjs/cdn-assets@11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.3.1/dist/mermaid.min.js"></script>
</head>

<body data-new-gr-c-s-check-loaded="14.1014.0" data-gr-ext-installed="" data-new-gr-c-s-loaded="14.1014.0">
  <div class="logged-in-box auth0-box logged-in">
    <h2>Happy chatting!</h2>
    <div>You can include the chat on your own website using the following code:</div>
    <div class="code"><code><pre>
&lt;div id="rasa-chat-widget" data-websocket-url="https://example.com/"&gt;&lt;/div&gt;
&lt;script src="https://unpkg.com/@rasahq/rasa-chat" type="application/javascript"&gt;&lt;/script&gt;
    </pre></code></div>
  </div>
  <p class="content">Make sure to replace <code>https://example.com/</code> with the URL of your server
    running your bot! You can find more documentation on how to use the chat widget
    on your own page in the
    <a href="https://rasa.com/docs/rasa/connectors/your-own-website#chat-widget">rasa documentation</a>
  </p>
  <div class="container">
    <div>
      <p class="content bold">Stack:</p>
      <table>
        <thead>
          <tr>
            <th># </th>
            <th>Type</th>
            <th>Flow</th>
            <th>Step Id</th>
          </tr>
        </thead>
        <tbody id="stack-frames">
        </tbody>
      </table>
      <p class="content bold">Set Slots:</p>
      <table>
        <thead>
          <tr>
            <th>Slot</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody id="slots">
        </tbody>
      </table>
      <div>
        <p class="content bold">End-2-End Test:</p>
        <div>
          <pre class="code language-json"><code id="e2e-test"></code></pre>
        </div>
      </div>
      <div>
        <p class="content bold">Tracker State:</p>
        <div>
          <pre class="code language-json"><code id="json-data">No story yet</code></pre>
        </div>
      </div>
    </div>
    <div>
      <p class="content bold">Current Flow:</p>
      <div>
        <pre class="mermaid" id="flow">
        </pre>
      </div>
    </div>
  </div>
  <div id="rasa-chat-widget" data-websocket-url="" data-default-open=true data-height="500"></div>

  <script>
    let chatDiv = document.getElementById("rasa-chat-widget");
    let websocketUrl = window.location.origin.replace("http", "ws")
    let maxHeight = document.documentElement.scrollHeight - 150;
    chatDiv.setAttribute("data-websocket-url", websocketUrl);
    chatDiv.setAttribute("data-height", maxHeight)
  </script>

  <script>
    mermaid.initialize({ startOnLoad: false });

    var previousTrackerState = null;

    let get_flows = fetch("/flows")
      .catch(error => console.error(error))
      .then(response => {
        if (!response.ok) {
          console.error("Error: Flows not found");
          return [];
        }
        return response.json()
      })
      .then(data => {
        return data;
      });

    function fetchStory() {
      let conversationId = window.rasaChatSessionId || "";
      fetch("/conversations/" + conversationId + "/story")
        .catch(error => console.error(error))
        .then(response => {
          if (!response?.ok) {
            console.error("Error: Story not found");
            return "No story yet";
          }
          return response.text();
        })
        .then(data => {
          let storyBlock = document.getElementById("json-data");
          if (storyBlock.textContent === data) {
            return;
          }
          storyBlock.textContent = data;
          if (window.hljs) {
            hljs.highlightElement(storyBlock);
          }
        });
    }
    async function fetchTracker() {
      let conversationId = window.rasaChatSessionId || "";
      await fetch("/conversations/" + conversationId + "/tracker?start_session=false")
        .catch(error => console.error(error))
        .then(response => {
          if (!response?.ok) {
            console.error("Error: Story not found");
            return [];
          }
          return response.json()
        })
        .then(async (data) => {
          let slots = data.slots;
          if(JSON.stringify(previousTrackerState) === JSON.stringify(data)){
            return;
          }
          previousTrackerState = data;

          // update e2e-test
          let e2eTest = document.getElementById("e2e-test");
          let steps = []
          for (var i = 0; i < data.events.length; i++) {
            let event = data.events[i];
            if(event.event == "user"){
              steps.push({"user": event.text});
            }
            if(event.event == "bot"){
              if (event.metadata?.utter_action) {
                steps.push({"utter": event.metadata.utter_action});
              } else {
                steps.push({"utter": event.text});
              }
            }
          }
          let e2eTestCase = {"test_cases": [{"test_case": data.sender_id, "steps": steps}]}
          e2eTest.textContent = jsyaml.dump(e2eTestCase);
          if (window.hljs) {
            hljs.highlightElement(e2eTest);
          }

          let root = document.getElementById('slots');
          root.innerHTML = '';
          let sortedSlotNames = Object.keys(slots).sort()
          for (var i = 0; i < sortedSlotNames.length; i++) {
            let name = sortedSlotNames[i];
            let slotValue = JSON.stringify(slots[name], null, 2);
            if(name == "flow_stack" || slotValue == 'null'){
              continue;
            }
            root.insertAdjacentHTML('beforeend', `<tr><td>${name}</td><td>${slotValue}</td></tr>`);
          }
          root.insertAdjacentHTML('beforeend', `<tr><td>\<\<\< all others \>\>\></td><td>None</td></tr>`);

          let stackEl = document.getElementById('stack-frames');
          let stackFrames = slots.flow_stack ?? [];
          stackEl.innerHTML = '';
          if(stackFrames.length == 0){
            stackEl.insertAdjacentHTML('afterbegin', `<tr class="center"><td colspan=4>--- Empty ---</td></tr>`);
          } else {
            for (var i = 0; i < stackFrames.length; i++) {
              let stackFrame = stackFrames[i];
              stackEl.insertAdjacentHTML('afterbegin', `<tr><td>${i+1}</td><td>${stackFrame.frame_type}</td><td>${stackFrame.flow_id}</td><td>${stackFrame.step_id}</td></tr>`);
            }
          }
          let activeFlow = stackFrames[stackFrames.length - 1]?.flow_id;
          let activeStep = stackFrames[stackFrames.length - 1]?.step_id;
          let flows = await get_flows;
          // find flow by going through array and checking for the id field
          let flow = flows.find(flow => flow.id === activeFlow);
          var mermaidText = `---
title: ${flow?.id ?? "No Flow"}
---
flowchart TD
classDef question stroke-width:1px
classDef action fill:#FBFCFD,stroke:#A0B8CF
classDef link fill:#f43
classDef slot fill:#aaa
classDef active stroke:#5A17ED,stroke-width:3px,stroke-dasharray: 5 3
          `;

          if (flow) {
            for (var i = 0; i < flow.steps.length; i++) {
              let step = flow.steps[i]
              if (step.question){
                let slotValue = slots[step.question] ? `_${slots[step.question]}_` : "\uD83D\uDCAC";
                mermaidText += `${flow.steps[i].id}["\`${flow.steps[i].question}\n${slotValue}\`"]:::question\n`;
              }
              if (step.action){
                mermaidText += `${flow.steps[i].id}["${flow.steps[i].action}"]:::action\n`;
              }
              if (step.link){
                mermaidText += `${flow.steps[i].id}["\uD83D\uDD17 ${flow.steps[i].link}"]:::link\n`;
              }
              if (step.set_slots){
                mermaidText += `${flow.steps[i].id}["\uD83E\uDEA3 ${flow.steps[i].id}"]:::slot\n`;
              }

              if (step.id === activeStep) {
                mermaidText += `class ${step.id} active\n`;
              }

              // if next is an id, then it is a link
              if (step.next && typeof step.next === "string") {
                mermaidText += `${step.id} --> ${step.next}\n`;
              }
              // if next is an array, then it is a list of conditions
              if (step.next && Array.isArray(step.next)) {
                for (var j = 0; j < step.next.length; j++) {
                  let condition = step.next[j];
                  if(condition.then){
                    mermaidText += `${step.id} -->|${condition.if}| ${condition.then}\n`;
                  }
                  if(condition.else){
                    mermaidText += `${step.id} -->|else| ${condition.else}\n`;
                  }
                }
              }
            }
          }
          let flowEl = document.getElementById('flow');
          console.log(mermaidText);
          const { svg } = await mermaid.render('graphDiv', mermaidText);
          flowEl.innerHTML = svg;
        });
    }

    setInterval(fetchStory, 1000); // fetch the Story every second
    setInterval(fetchTracker, 1000); // fetch the Tracker every second
  </script>

  <script src="https://unpkg.com/@rasahq/rasa-chat" type="application/javascript"></script>
</body>

</html>