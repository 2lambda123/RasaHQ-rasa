---
id: tutorial
sidebar_label: Tutorial
title: Tutorial
className: hide
abstract:
---

import useBaseUrl from '@docusaurus/useBaseUrl';

You will build an assistant in this tutorial for helping people transfer money. 
This tutorial does not assume and existing knowledge of Rasa or chatbots.
The techniques you will learn in this tutorial are fundamental to building any Rasa bot,
and understanding it will bring you quite far along to mastering Rasa.


## What are you building?

In this tutorial, you will build a robust assistant that can complete a money transfer, and
doesn't get confused as soon as a user says something unexpected. 

Here are some of the conversations your assistant will be able to handle:

<Tabs values={[{"label": "Happy path", "value": "happy-path"}, {"label": "Complete request", "value": "all-upfront"}, {"label": "Change of mind", "value": "change-mind"}, {"label": "Interjection", "value": "interjection"}]}  groupId="example-conversations" defaultValue="happy-path">
  <TabItem value="happy-path">
    <Chat caption="happy path">
    <ChatUserText>I'd like to transfer some money</ChatUserText>
    <ChatBotText>Sure - who are we sending money to?</ChatBotText>
    <ChatUserText>Jen</ChatUserText>
    <ChatBotText>How much would you like to send?</ChatBotText>
    <ChatUserText>$50</ChatUserText>
    <ChatBotText>Just to confirm: you want to send $50 to Jen?</ChatBotText>
    <ChatUserText>yes</ChatUserText>
    <ChatBotText>Ok, it's done!</ChatBotText>
    </Chat>
  </TabItem>
  <TabItem value="all-upfront">
    <Chat caption="All info given">
    <ChatUserText>I want to send $100 to Joe</ChatUserText>
    <ChatBotText>Just to confirm, you want to send $100.00 to Joe Smith?</ChatBotText>
    <ChatUserText>yes.</ChatUserText>
    <ChatBotText>All done. $100.00 has been sent to Joe Smith.</ChatBotText>
    <ChatBotText>Is there anything else I can help you with?</ChatBotText>
    </Chat>
  </TabItem>  
  <TabItem value="change-mind">
    <Chat caption="user changes their mind">
    <ChatUserText>Can you recommend somewhere to eat?</ChatUserText>   
    </Chat>
  </TabItem>
  <TabItem value="interjection">
    <Chat caption="user interjects with a question">  
    </Chat>
  </TabItem>  
</Tabs>

## Setup

If you haven't installed Rasa yet, go to the installation page (link) and then return here. 
To code along with this tutorial, first create an empty folder for your project, open it in your terminal, and run:

```bash
rasa init --tutorial
```

## Overview

Open up the project folder in your IDE to see the files that make up your new project.
In this tutorial you will primarily work with the following files:

* `data/flows.yml`
* `domain.yml`
* `actions/actions.py`

## Testing your money transfer skill

Train your assistant by running:

```bash
rasa train
```

And start talking to it in the shell by running:

```bash
rasa shell
```

Tell the bot that you'd like to transfer some money to a friend.

## Understanding your money transfer skill.

The file `data/flows.yml` contains the definition of a `flow` called `transfer_money`. 
Let's look at this definition to see what is going on:

```yaml
flows:
  transfer_money:
    description: This flow lets users send money to friends and family.
    steps:
      - id: "ask_recipient"
        collect_information: recipientgi
        next: "ask_amount"
      - id: "ask_amount"
        collect_information: amount
        next: "utter_transfer_complete"
      - id: "transfer_successful"
        action: utter_transfer_complete        
```

The two key attributes of the `transfer_money` flow are the `description` and the `steps`.
The `description` is helpful for anyone who inspects your code to understand what is going on.
But it is also used to help decide _when_ to activate this flow. 
If a user says "I need to transfer some money", the description helps Rasa understand that this is the relevant flow.
The `steps` describe the business logic required to do what the user asked for.


There are three steps defined, each with an `id`. 
The `id` can be anything you like, but it's a good idea to use names that make it clear what is going on. 
The first step is a `collect_information` step, which is used to fill a `slot`.
A `collect_information` step sends a message to the user requesting information, and waits for an answer.


## Collecting Information in Slots

`Slots` are a key-value memory store used during a conversation.
Slots are defined in your `domain.yml` file. For example, the definition of your `recipient` slot looks like this:

```yaml
slots:
  recipient:
    type: Text
    mappings:
      - type: custom
```

They can be used to store information provided to you by the user or fetched via an API call.
First, you're going to see how to store information provided by the end user in a slot.
To do this, you define a `collect_information` step like the first step in your flow above.

```yaml
flows:
  transfer_money:
    description: This flow lets users send money to friends and family.
    steps:
      - id: "ask_recipient"
        // highlight-next-line
        collect_information: recipient
        next: "ask_amount"
      - id: "ask_amount"
        collect_information: amount
        next: "utter_transfer_complete"
      - id: "transfer_successful"
        action: utter_transfer_complete        
```

Rasa will look for a  `response` called `utter_ask_recipient` in your domain file and use this to 
phrase the question to the user. It will then wait for a response. 

```yaml
responses:
  utter_ask_recipient:
    - text: "Who would you like to send money to?"
```

Rasa will try to use this answer to fill the slot `recipient`.
Read about slot validation (link) to learn more about how to check the value of the slot is OK,
and how to handle the case when it isn't.

<img alt="explanation of how slots are used in flows" src={useBaseUrl("/img/slots_in_flows.png")} />

## Steps that do not Collect Information

The third `step` in your `transfer_money` flow is not a `collect_information` step but an `action` step.
When you reach an action step in a flow, your assistant will execute the corresponding action and then 
proceed to the next step.
It will not stop to wait for the user's next message. 
For now, this is the final step in the flow, so there is no next step to execute and the flow completes. 

## Adding a Confirmation Step

Slots are also used to build branching logic in flows.

You're going to introduce an extra step, asking the user to confirm the amount and the recipient before 
sending the transfer. 
Since you are asking a yes/no question, you can store the result in a boolean `slot`.

In your domain file, add the definition of this slot and the corresponding response:

```yaml
slots:
  recipient:
    type: Text
    mappings:
      - type: custom
  // highlight-start  
  final_confirmation:
    type: bool
    mappings:
      - type: custom
  // highlight-end
```

```yaml
responses:
  utter_ask_recipient:
    - text: "Who would you like to send money to?"
  // highlight-start      
  utter_ask_final_confirmation:
    - text: "Please confirm: you want to transfer {amount} to {recipient}?"
  // highlight-end    
```

Notice that your confirmation question uses curly brackets `{}` to include slot values in your response. 

Add a `collect_information` step to your flow and give it the id `confirm_transfer`.
Also change the `next` attribute of the `ask_amount` step to match the `id` of your newly created step: `confirm_transfer`.


```yaml
flows:
  transfer_money:
    description: This flow lets users send money to friends and family.
    steps:
      - id: "ask_recipient"
        collect_information: recipient
        next: "ask_amount"
      - id: "ask_amount"
        collect_information: amount
        // highlight-start           
        next: "confirm_transfer"
      - id: "confirm_transfer"
        collect_information: final_confirmation
        next:
          - if: final_confirmation
            then: "transfer_successful"
        // highlight-end
      - id: "transfer_successful"
        action: utter_transfer_complete
```

The `next` attribute of your `confirm_transfer` step includes a `condition`.
The expression after the `if:` key will be evaluated and return `True` or `False`.
In this case, we're using the value of the boolean slot `final_confirmation`. 
Conditions can be used to create branching logic, including logical operators like `and`, `or`, etc.
Learn more about conditions here (link). 

To try out the updated version of your assistant, run `rasa train`, and then `rasa shell` to talk to your bot.
It should now ask you to confirm before completing the transfer. 


## Integrating an API call

An `action` step in a flow can describe two types of actions.
If the name of the action starts with `utter_`, then this action sends a message to the user.
The name of the action has to match the name of one of the `responses` defined in your domain.
The final step in your flow contains the action `utter_transfer_complete`, and this response is 
also defined in your domain. Responses can contain buttons, images, and custom payloads. 
You can learn more about everything you can do with responses here (link). 

The second type of `action` is a custom action. The name of a custom action starts with `action_`. 

You are going to create a custom action, `action_check_balance`, to check whether the user has enough money
to make the transfer, and then add logic to your flow to handle both cases.

You are going to create your custom action by editing the `actions/actions.py` file.
To learn more about custom actions, including how to build custom actions in languages other than python, go here (link). 

Uncomment the import statements at the top of your `actions/actions.py` file, and add the following: 

```python
from typing import Any, Text, Dict, List
from rasa_sdk import Action, Tracker
from rasa_sdk.executor import CollectingDispatcher
from rasa_sdk.events import SlotSet

class ActionSufficientBalance(Action):
    def name(self) -> Text:
        return "action_sufficient_balance"

    def run(self, dispatcher: CollectingDispatcher,
            tracker: Tracker,
            domain: Dict[Text, Any]) -> List[Dict[Text, Any]]:
        balance = 1000 # hard-coded for tutorial purposes
        # a real api call would look something like
        # result = requests.get("https://example.com/api/balance")
        # balance = result.json()["balance"]
        transfer_amount = tracker.get_slot("amount")
        has_sufficient_funds = transfer_amount < balance
        return [SlotSet("has_sufficient_funds", has_sufficient_funds)]
```

Slots are the primary way to pass information to and from custom actions.
In the `run()` method above, you access the value of the `amount` slot that was set during the conversation,
and you pass information back to the conversation by returning a `SlotSet` event.

Now add the action and the corresponding slot following to your `domain.yml`, so that your assistant knows it can use this action:

```yaml
actions:
  - action_sufficient_balance

slots:
  - has_sufficient_funds:
    type: bool
    mappings:
      - type: custom
```

Now you are going to update your flow logic to handle the cases where the user does or does not have
 enough money in their account to make the transfer. 

```yaml
flows:
  transfer_money:
    description: This flow lets users send money to friends and family.
    steps:
      - id: "ask_recipient"
        collect_information: recipient
        next: "ask_amount"
      - id: "ask_amount"
        collect_information: amount
        // highlight-start        
        next: "check_balance"
      - id: "check_balance"
        action: check_balance
        next:
          - if: has_sufficient_funds
            then: "confirm_transfer"
          - else: "insufficient_funds"
      - id: "insufficient_funds"
        action: utter_transfer_money_insufficient_funds      
        // highlight-end      
      - id: "confirm_transfer"
        collect_information: final_confirmation
        next:
          - if: final_confirmation
            then: "transfer_successful"

      - id: "transfer_successful"
        action: utter_transfer_complete
```

# How-to Guides for Advanced Topics

### Slot Validation
Use custom logic to determine whether to accept or reject the value of a slot provided by the user. 

### Handling Corrections
Handle cases where the user changes their mind about something and provides an new answer to an earlier question.

### Handling Digressions
Handle cases where users ask clarifying questions, make small talk, etc.

### Customising Patterns
Customise how Rasa switches between flows and other common conversational patterns.

### Contextual Paraphrasing
Use LLMs to paraphrase templated responses to account for context and increase fluency. 
<RasaProLabel />

### Linking Flows
Link multiple flows together, build shared sub-flows
<RasaProLabel />

### Integrating Search & RAG
Integrate flow-based and knowledge-based dialogue into fluent conversations.
<RasaProLabel />

### Handling Disambiguation
Automatically ask clarifying questions when it is not clear which flow applies. 
<RasaProLabel />
