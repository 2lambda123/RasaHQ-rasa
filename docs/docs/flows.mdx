---
id: flows
sidebar_label: Business Logic with Flows
title: Business Logic with Flows
abstract: |
  Flows in Rasa offer a structured way to design conversation-driven business
  logic. The documentation details the rules for effectively using and managing
  Flows within Rasa.
---

import RasaDiscoveryBanner from "@theme/RasaDiscoveryBanner";

<RasaDiscoveryBanner/>

## Overview

**Flow** is a novel Rasa feature designed to build intuitive,
conversation-centric business logic for your chatbots. Flows are primarily
devised using Studio's Flow builder. However, as a Rasa core feature, they also
offer a YAML counterpart, yielding a specification for creating Flow primitives
in YAML.

In essence, a **Flow** embodies a conversational state machine in the form of a
directed graph. The primary building block of a Flow is a **Step**, equivalent
to a node in the graph. Each step outlines the potential subsequent steps, which
may be associated with certain conditions. Hence, graph vertices are embedded in
steps.

### YAML Specification for Flow

A Flow is defined using the following structure:

```yaml
flows:
  a_flow: # an id
    name: A flow # a name
    description: optional description of a flow
    steps: [] # a list of steps
```

## Steps

A `Flow` comprises `step`s. All steps share these common properties:

```yaml
id: a_required_unique_id
description: an optional human readable description of the step
metadata: {} # an optional dict
next: an id or conditionals to determine which step should be executed next
```

Steps can manifest in one of three types: `user_message`, `action`, or
`question`.

### User Message (`user_message`)

This step signifies a user utterance. Here's an example:

```yaml
- id: a_required_unique_id
  intent: open_bank_account
  entities: [] # optional
  description: open a bank account
  metadata: {} # an optional dict
  next: "5"
```

In this example, the user intent is to open a bank account. The `next` field
indicates the ID of the next step to be taken in the flow, which would be the
step with the ID "5".

A `user_message` step can also support `OR` statements. This means that the flow
can proceed if either of the conditions in the `OR` statement are met:

```yaml
- id: a_required_unique_id
  or:
    - intent: complaint
      entities: [] # optional
    - intent: talk_to_agent
      entities: [] # optional
  description: handle a complaint or talk to an agent
  metadata: {} # an optional dict
  next: "5"
```

Here, if the user intent is either to make a complaint or to talk to an agent,
the flow would proceed to the step with ID "5".

### Action (`action`)

An `action` step is where the bot performs a specific action or utters a
message. Here are two examples:

```yaml
action: action_xyz
```

This could be a custom action where the bot performs a specific function defined
in your custom actions script.

```yaml
action: utter_xyz
```

This is an utterance action where the bot sends a predefined message to the
user. The message for "utter_xyz" would be defined in the domain file under
responses.

### Question (`question`)

In a `question` step, the bot asks a question, with the aim usually being to
fill a slot. Here is an example:

```yaml
question: account_type # slot name
```

In this example, the bot is asking the user to provide their account type. 
The response will be used to fill the "account_type" slot.

A question can be configured to be skipped if the slot is already filled, as
shown below:

```yaml
question: first_name # slot name
skip_if_filled: true
```

In this scenario, if the "first_name" slot is already filled, the bot will skip
this question.

The slot can also be configured to be cleared at the end of the flow execution.
The following configuration would clear the slot when a leaf of the flow is
reached OR when exiting a `link`ed node:

```yaml
question: yes_or_no # slot name
scope: flow | global
```

For the `slot_type`, it's recommended to use `text` slots in Flows.

### Scope (`scope`)

Scopes determine the lifespan of a slot or variable. There are two types of
scopes available:

- **flow**: The variable exists only for the duration of the flow. Once the flow
  ends, the variable ceases to exist.
- **global**: The variable persists across flows until it is explicitly changed.

### Fill (`fill`)

`Fill` refers to the process of filling slots based on user responses. It is a
simplified version of slot mapping. Below is an example of mapping from
entities:

```yaml
fill:
  entity: entity_name
  window: question | flow | global
```

Here, the "entity_name" entity from the user's message is extracted and used to
fill a corresponding slot.

Or mapping from intent (or button payload):

```yaml
fill:
  intent: affirm
  value: "true"
  window: question
```

Here, if the user's intent is "affirm", the corresponding slot will be filled
with the value "true".

### Next (`next`)

The `next` field in steps allows for branching logic. For instance:

```yaml
- id: "2"
  question: age 
  next:
    - if: age < 18
      then: "3"
    - else: "4"
```

In this example, depending on the user's input value for age,
the flow will proceed to step "3" or "4", respectively. This allows you to
create complex and dynamic conversational flows that adapt to user inputs.

## Examples

### Hello World Flow

```yaml
flows:
  hello_world:
    name: Hello World!
    description: A basic flow
    steps:
      - id: "1"
        intent: greet
        next: "2"
      - id: "2"
        action: utter_greet
```

The intent `greet` and the response template `utter_greet` needs to be defined in
the domain file.

The `next` property determines the id of the next step and links all the 
different steps together.

### A basic flow with branching

```yaml
flows:
  basic_flow_with_branching:
    name: basic flow with branching
    description: a flow with a branch
    steps:
      - id: "1"
        intent: greet
        next: "2"
      - id: "2"
        action: utter_greet
        next: "3"
      - id: "3"
        question: age
        next:
          - if: age < 18
            then: "4"
          - else: "5"
      - id: "4"
        action: utter_too_young
      - id: "5"
        action: utter_old_enough
```

The example shows a flow that branches based on logic.

### Asking for confirmation

```yaml-rasa title="flows.yml"
flows:
  transfer_money:
    description: This flow demonstrates asking for confirmation from the user.
    steps:
      - id: "0"
        intent: transfer_money
        next: "1"
      - id: "1"
        question: money
        next: "2"
      - id: "2"
        question: confirm_transfer
        next:
          - if: confirm_transfer == "yes"
            then: "3"
          - else: "4"
      - id: "3"
        action: utter_transfer_success
      - id: "4"
        action: utter_transfer_cancel
```

The example shows a flow that can take confirmation from the user and branch based on it.

```yaml-rasa title="domain.yml"
slots:
  money:
    type: float
    mappings:
    - type: from_text
      conditions:
      - active_loop: question_money
        requested_slot: money
  confirm_transfer:
    type: text
    mappings:
    - type: from_text
      conditions:
      - active_loop: question_confirm_transfer
        requested_slot: confirm_transfer

responses:
  utter_ask_money:
    - text: "How much money do you wish to transfer?"
  utter_ask_confirm_transfer:
    - text: "Do you wish to proceed with the transfer?"
```
The snippet shows the responses and slot configuration that is needed to make the `question` steps in the `tranfer_money` flow work.

#### Flows branching on the result of the user selection
```yaml-rasa title="flows.yml"
flows:
  user_selection_based_flow_branching_example:
    description: This flow opens a bank account based on the user's choice of account model.
    steps:
      - id: "1"
        intent: greet
        next: "2"
      - id: "2"
        action: utter_greet
        next: "3"
      - id: "3"
        question: account_type
        next:
          - if: account_type == "checking"
            then: "5"
          - if: account_type == "savings"
            then: "7"
          - else: "9"
      - id: "5"
        question: specific_checking_question
        next: "6"
      - id: "6"
        action: utter_something_specific_to_checking
        next: "11"
      - id: "7"
        question: specific_savings_question
        next: "8"
      - id: "8"
        action: utter_something_specific_to_savings
        next: "11"
      - id: "9"
        question: specific_credit_card_question
        next: "10"
      - id: "10"
        action: utter_something_specific_to_credit_card
        next: "11"
      - id: "11"
        action: action_open_account
```

### Multiple Flows with links

```yaml
flows:
  flow_with_links:
    name: flow with links
    description: optional description of a flow with links
    steps:
      - id: "1"
        intent: greet
        next: "2"
      - id: "2"
        action: utter_greet
        next: "3"
      - id: "3"
        link: collect_personal_details
        next:
          - if: age < 18
            then: "4"
          - else: "5"
      - id: "4"
        action: utter_too_young
        next: "6"
      - id: "5"
        action: utter_old_enough
        next: "6"
      - id: "6"
        link: another_flow

  collect_personal_details:
    name: collect details
    description: gather personal details from the user
    steps:
      - id: "1"
        question: first_name
        next: "2"
      - id: "2"
        question: last_name
        next: "3"
      - id: "3"
        question: age
```
