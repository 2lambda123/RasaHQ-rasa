---
id: flows
sidebar_label: Business Logic with Flows
title: Business Logic with Flows
abstract: |
  Flows in Rasa offer a structured way to design conversation-driven business
  logic. The documentation details the rules for effectively using and managing
  Flows within Rasa.
---

import RasaDiscoveryBanner from "@theme/RasaDiscoveryBanner";

<RasaDiscoveryBanner />

## Overview

**Flow** is a novel Rasa feature designed to build intuitive,
conversation-centric business logic for your chatbots. Flows are primarily
devised using Studio's Flow builder. However, as a Rasa core feature, they also
offer a YAML counterpart, yielding a specification for creating Flow primitives
in YAML.

In essence, a **Flow** embodies a conversational state machine in the form of a
directed graph. The primary building block of a Flow is a **Step**, equivalent
to a node in the graph. Each step outlines the potential subsequent steps, which
may be associated with certain conditions. Hence, graph vertices are embedded in
steps.

A Flow is defined using YAML syntax. The following example illustrates a simple
Flow:

```yaml title="flows.yml"
flows:
  hello_world:
    name: "Hello World"
    description: "A simple flow that greets the user"
    steps:
      - id: "0"
        user_message: "greet"
        next: "1"
      - id: "1"
        action: "utter_greet"
```

## Flow Properties

A Flow is defined using the following properties:

```yaml title="flows.yml"
flows:
  a_flow: # an id
    name: "A flow" # a name
    description: "description of the purpose of the flow"
    steps: [] # a list of steps
```

### Name

The `name` field is a required human readable name for the flow.

### Description

The `description` field is a summary of the flow. It is required, and should
describe the purpose of the flow. Other components, such as the
[LLMCommandGenerator](./llms/llm-command-generator.mdx), use the description to
decide when to start the flow.

### Steps

The `steps` field is a required list of steps that make up the flow. The steps
are executed in the order they are defined in the list.

All steps share these common properties:

```yaml
- id: "a_required_unique_id"
  description: "an optional human readable description of the step"
  metadata: {} # an optional dict
  next: "an id or conditionals to determine which step should be executed next"
```

#### Id Property

The `id` field is a required unique identifier for each step. It is used to
reference the step in the `next` field of other steps.

#### Next Property

The `next` field in steps allows to link steps together and create branching
logic.

To link to the next step, you can use the `id` of the next step:

```yaml
- id: "some_question"
  question: "age"
  next: "id_of_the_next_step"
```

To create branching logic, you can use conditionals:

```yaml
- id: "some_question"
  question: "age"
  next:
    - if: age < 18
      then: "under_18_step"
    - if: age >= 18 and age < 65
      then: "18_to_65_step"
    - else: "over_65_step"
```

In this example, depending on the user's input value for age, the flow will
proceed to different steps. This allows you to create complex and dynamic
conversational flows that adapt to user inputs.

The `next` field can also be omitted. In this case, the flow will end.

#### Step types

Steps can manifest in one of the following types:

- [entry prompt step](./flows.mdx#entry-prompt): an LLM prompt that will be used
  to determine if the flow should start
- [action step](./flows.mdx#action): a custom action or utterance action to be
  run by the flow
- [generation prompt step](./flows.mdx#generation-prompt): a prompt to generate
  a message that will be sent to the user
- [set slots step](./flows.mdx#set-slots): a step to set slots
- [question step](./flows.mdx#question): a question to be asked to the user
- [link step](./flows.mdx#link): a step to link to another flow

### Starting a Flow

Flows can be triggered by other Rasa components, e.g. the
[LLM Command Generator](./llms/llm-command-generator.mdx). The description of
each flow is very important for the LLM Command Generator, as it uses the
description to determine which flow to trigger.

An Alternative way to trigger flows is using an
[entry prompt step](./flows.mdx#entry-prompt). Entry prompts trigger an LLM call
with the given context and a yes/no question to determine whether to start the
flow.

## Step Types

Every step in a flow has a type. The type determines what the step does and what
properties it supports.


{/* ### User Message

This step signifies a user utterance. Here's an example:

```yaml
- id: "an_incoming_user_message"
  intent: "greet"
  entities: [] # optional
  description: "greet the user"
  metadata: {} # an optional dict
```

User steps can only be used as a first step in a flow. They can be used to
trigger a flow when a user sends a message that matches the intent and entities
specified in the step.

A `user_message` step can also support `OR` statements. This means that the flow
can proceed if either of the conditions in the `OR` statement are met:

```yaml
- id: "a_required_unique_id"
  or:
    - intent: "complaint"
      entities: [] # optional
    - intent: "talk_to_agent"
      entities: [] # optional
  description: "handle a complaint or talk to an agent"
  metadata: {} # an optional dict
```

Here, if the user intent is either to make a complaint or to talk to an agent,
the flow should be started. \*/}


### Entry Prompt

An `entry_prompt` step is used to determine if a flow should be started. Here's
an example:

```yaml
- id: "start_if_sensitive_topic"
  entry_prompt: |
    Below is the message from the user to the specialized
    financial chatbot. Can you detect the sensitive topic, not related to
    the scope of the bot? Reply "yes" or "no" and nothing else.

    {{latest_user_message}}
  advance_if: "yes" # optional, defaults to "yes"
  llm: # optional, defaults to "openai"
    type: "openai"
```

When a new message is received, the `entry_prompt` will be sent to an LLM. If
the LLM responds with the value specified in `advance_if`, the flow will be
started.

:::caution

Entry prompts should be **used infrequently**, as the prompt will be sent to an
LLM for every incoming user message. Having to many entry prompts can slow down
the bot.

:::

Good use cases for entry prompts are detecting sensitive topics or out of scope
messages.

:::info Using Other LLMs

By default, OpenAI is used as the underlying LLM.

The used LLM provider can be configured as part of the properties of the flow
step and another provider, e.g. `cohere` can be used:

```yaml
- id: "start_if_sensitive_topic"
  entry_prompt: |
    Below is the message from the user to the specialized
    financial chatbot. Can you detect the sensitive topic, not related to
    the scope of the bot? Reply "yes" or "no" and nothing else.

    {{latest_user_message}}
  advance_if: "yes"
  llm:
    type: "cohere"
```

For more information, see the
[LLM setup page on llms and embeddings](./llms/llm-setup.mdx#other-llms--embeddings)

:::

### Action

An `action` step is where the bot performs a specific action or utters a
message. Here are two examples:

```yaml
- id: "an_action"
  action: "action_xyz"
```

This could be a custom action where the bot performs a specific function defined
in your custom actions script.

```yaml
- id: "an_utter_action"
  action: "utter_xyz"
```

This is an utterance action where the bot sends a predefined message to the
user. The message for "utter_xyz" would be defined in the domain file under
responses.

### Generation Prompt

A `generation_prompt` step contains a prompt that is used to generate a message
using an LLM. The message is then sent to the user. Here is an example:

```yaml
- id: "a_generation_step"
  generation_prompt: |
    You are an incredibly friendly assistant. Generate a short 
    response to the user's comment in simple english.

    User: {{latest_user_message}}
    Response:
  llm: # optional, defaults to "openai"
    type: "openai"
```

The `generation_prompt` field contains the prompt that will be sent to the LLM
to generate a message. The prompt can use the following available variables:

- `{{latest_user_message}}`: the latest user message, e.g.
  ```
  How are you?
  ```
- `{{history}}`: the history of the conversation so far, e.g.
  ```
  User: Hello
  Bot: Hi
  User: How are you?
  ```

The generated message will be sent to the user. The flow will proceed to the
next step once the message is sent.

:::info Using Other LLMs

By default, OpenAI is used as the underlying LLM.

The used LLM provider can be configured as part of the properties of the flow
step and another provider, e.g. `cohere` can be used:

```yaml
- id: "a_generation_step"
  generation_prompt: |
    You are an incredibly friendly assistant. Generate a short 
    response to the user's comment in simple english.

    User: {{latest_user_message}}
    Response:
  llm:
    type: "cohere"
```

For more information, see the
[LLM setup page on llms and embeddings](./llms/llm-setup.mdx#other-llms--embeddings)

:::

### Set Slots

A `set_slots` step is used to set a slot. Here is an example:

```yaml
- id: "a_set_slot_step"
  set_slots:
    - account_type: "savings"
```

In this example, the slot with the key `account_type` is set to the value
`savings`. Multiple slots can be set in one step, as shown below:

```yaml
- id: "a_set_slot_step"
  set_slots:
    - account_type: "savings"
    - account_number: "123456789"
```

### Question

In a `question` step, the bot asks a question, with the aim usually being to
fill a slot. Here is an example:

```yaml
- id: "a_question_step"
  question: "account_type" # slot name
```

In this example, the bot is asking the user to provide their account type. The
response will be used to fill the "account_type" slot.

:::note

The slot needs to be defined in the domain file. See the
[domain documentation](./domain.mdx) for more information. Additionaly, the slot
should have fitting slot mappings.

:::

For the `slot_type`, it's recommended to use `text` slots in Flows.

#### Skipping Questions

By default, a question is skipped if the slot is already filled. If a question
should always be asked, no matter if the underlying slot is already filled, you
can set `skip_if_filled: false` on the question:

```yaml
- id: "confirm_dangerous_step"
  question: "final_confirmation" # slot name
  skip_if_filled: false
```

If the "final_confirmation" slot is already filled, the bot will clear it, ask
the question and fill the slot again. This ensures the confirmation question is
always asked.

#### Scopes

Scopes determine the lifespan of a slot or variable. There are two types of
scopes available:

- **flow**: The variable exists only for the duration of the flow. Once the flow
  ends, the variable ceases to exist.
- **global**: The variable persists across flows until it is explicitly changed.

The slot can also be configured to be cleared at the end of the flow execution.
The following configuration would clear the answer to the question when a flow
is completed.

```yaml
- id: "another_confirmation_step"
  question: "yes_or_no" # slot name
  scope: "flow"
```

### Link

A `link` step is used to link to another flow. Here is an example:

```yaml
- id: "a_link_step"
  link: "id_of_another_flow"
```

In this example, the bot will proceed to the flow with the id
`id_of_another_flow`. The bot will return to the current flow once the linked
flow is completed.

## Examples

### Hello World Flow

```yaml
flows:
  hello_world:
    name: "Hello World!"
    description: "A basic flow"
    steps:
      - id: "1"
        intent: "greet"
        next: "2"
      - id: "2"
        action: "utter_greet"
```

The intent `greet` and the response template `utter_greet` needs to be defined
in the domain file.

The `next` property determines the id of the next step and links all the
different steps together.

### A basic flow with branching

```yaml
flows:
  basic_flow_with_branching:
    name: "basic flow with branching"
    description: "a flow with a branch"
    steps:
      - id: "1"
        intent: "greet"
        next: "2"
      - id: "2"
        action: "utter_greet"
        next: "3"
      - id: "3"
        question: "age"
        next:
          - if: age < 18
            then: "4"
          - else: "5"
      - id: "4"
        action: "utter_too_young"
      - id: "5"
        action: "utter_old_enough"
```

The example shows a flow that branches based on logic.

### Asking for confirmation

```yaml-rasa title="flows.yml"
flows:
  transfer_money:
    description: "This flow demonstrates asking for confirmation from the user."
    steps:
      - id: "0"
        intent: "transfer_money"
        next: "1"
      - id: "1"
        question: "money"
        next: "2"
      - id: "2"
        question: "confirm_transfer"
        next:
          - if: confirm_transfer == "yes"
            then: "3"
          - else: "4"
      - id: "3"
        action: "utter_transfer_success"
      - id: "4"
        action: "utter_transfer_cancel"
```

The example shows a flow that can take confirmation from the user and branch
based on it.

```yaml-rasa title="domain.yml"
slots:
  money:
    type: float
    mappings:
    - type: from_text
      conditions:
      - active_loop: question_money
        requested_slot: money
  confirm_transfer:
    type: text
    mappings:
    - type: from_text
      conditions:
      - active_loop: question_confirm_transfer
        requested_slot: confirm_transfer

responses:
  utter_ask_money:
    - text: "How much money do you wish to transfer?"
  utter_ask_confirm_transfer:
    - text: "Do you wish to proceed with the transfer?"
```

The snippet shows the responses and slot configuration that is needed to make
the `question` steps in the `tranfer_money` flow work.

#### Flows branching on the result of the user selection

```yaml-rasa title="flows.yml"
flows:
  user_selection_based_flow_branching_example:
    description: "This flow opens a bank account based on the user's choice of account model."
    steps:
      - id: "1"
        intent: "greet"
        next: "2"
      - id: "2"
        action: "utter_greet"
        next: "3"
      - id: "3"
        question: "account_type"
        next:
          - if: account_type == "checking"
            then: "5"
          - if: account_type == "savings"
            then: "7"
          - else: "9"
      - id: "5"
        question: "specific_checking_question"
        next: "6"
      - id: "6"
        action: "utter_something_specific_to_checking"
        next: "11"
      - id: "7"
        question: "specific_savings_question"
        next: "8"
      - id: "8"
        action: "utter_something_specific_to_savings"
        next: "11"
      - id: "9"
        question: "specific_credit_card_question"
        next: "10"
      - id: "10"
        action: "utter_something_specific_to_credit_card"
        next: "11"
      - id: "11"
        action: "action_open_account"
```

This example flow demonstrates how to implement branching flows based on
multiple conditions. It involves fetching the slot `account_type` using a
`question` step, and the value of this slot is then used to determine which
specific flow should be executed.

### Multiple Flows with links

```yaml
flows:
  flow_with_links:
    name: "flow with links"
    description: "optional description of a flow with links"
    steps:
      - id: "1"
        intent: "greet"
        next: "2"
      - id: "2"
        action: "utter_greet"
        next: "3"
      - id: "3"
        link: "collect_personal_details"
        next:
          - if: age < 18
            then: "4"
          - else: "5"
      - id: "4"
        action: "utter_too_young"
        next: "6"
      - id: "5"
        action: "utter_old_enough"
        next: "6"
      - id: "6"
        link: "another_flow"

  collect_personal_details:
    name: "collect details"
    description: "gather personal details from the user"
    steps:
      - id: "1"
        question: "first_name"
        next: "2"
      - id: "2"
        question: "last_name"
        next: "3"
      - id: "3"
        question: "age"
```

This example demonstrates how the `link` step in flows enables the invocation of
another flow. Specifically, within the `flow_with_links` flow, the
`collect_personal_details` flow is called using the `link` step.
