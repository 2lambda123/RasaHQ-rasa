---
id: markers
sidebar_label: Markers
title: Markers
description: Find out how to mark points of interest in dialogues using Marker conditions.
abstract: Markers are conditions that allow you to describe and mark points of interest in user interactions.
---

:::caution

This feature is currently experimental and might change or be removed in the future. Share your feedback in the forum to help us make it production-ready.

:::

Markers allow you to describe points in a dialogue that you are interested in identifying. In Rasa, a dialogue is represented as a sequence of events, which include bot actions that were executed (`ActionExecuted`), intents that were detected (`UserUttered`), and slots that were set (`SlotSet`). A point of interest in a dialogue can thus be expressed as a logical expression that can be evaluated against the sequence of dialogue events. When this logical expression is met, we "mark" that point in the dialogue for further analysis or inspection.

There are several applications for Markers. For example, they can be used to define your bot's Key Performance Indicators (KPIs), such as dialogue completion or task success. For [Carbon Bot](https://rasa.com/blog/using-conversation-tags-to-measure-carbon-bots-success-rate/) (which helps users offset their carbon emissions from flying) dialogue completion can be defined as "all mandatory slots have been filled", while task success can be defined as "all mandatory slots have been filled and a carbon estimate has been successfully computed". Marking these events allows us to evaluate Carbon Bot's performance by quantifying how often it succeeds and how often it fails.

Markers also allow you to diagnose your dialogues by surfacing important events for further inspection. For example, we might observe that Carbon Bot tends to successfully set the `travel_departure` and `travel_destination` slots, but not the `travel_flight_class`. We can define a marker to quantify how often this scenario occurs and surface relevant dialogues for review as part of [Conversation Driven Development (CDD)](https://rasa.com/blog/conversation-driven-development-a-better-approach-to-building-ai-assistants/).

Markers are defined using a `YAML` syntax. For example, here are markers that define dialogue completion and task success for Carbon Bot:

```yaml
marker_dialogue_completion:
    and:
        - slot_was_set: travel_departure
        - slot_was_set: travel_destination
        - slot_was_set: travel_flight_class
marker_task_success:
    and:
        - slot_was_set: travel_departure
        - slot_was_set: travel_destination
        - slot_was_set: travel_flight_class
        - action: provide_carbon_estimate
```

And here is a marker for surfacing dialogues where all mandatory slots are set except `travel_flight_class`:

```yaml
marker_dialogue_incomplete:
    and:
        - slot_was_set: travel_departure
        - slot_was_set: travel_destination
        - not:
            slot_was_set: travel_flight_class
```

## Defining Markers

Markers are defined in a markers configuration file written in `YAML`.
Each marker should have a *unique identifier*, and consists of at least one *event condition*.
Markers can also contain *operators*, which allow you to express more nuanced behavior or
combine event conditions.

Consider the following marker definition:
```yaml
marker_mood_expressed:
    or:
        - intent: mood_unhappy
        - intent: mood_great
```
The unique marker identifier is `marker_mood_expressed`. The marker definition contains one operator, `or`,
and two event conditions, `intent: mood_unhappy` and `intent: mood_great`.

### Event Conditions

The following event condition labels are supported:

- `action`: the specified bot action was executed.
- `intent`: the specified user intent was detected.
- `slot_was_set`: the specified slot was set.

The negated forms of the labels are also supported:

- `not_action`: the event is not an `ActionExecuted` with the specified action.
- `not_intent`: the event is not a `UserUttered` with the specified intent.
- `slot_was_not_set`: the specified slot has not been set.

### Operators

The following operators are supported:

- `and`: all listed conditions applied.
- `or`: any of the listed conditions applied.
- `not`: the condition did not apply. `not` only accepts 1 condition.
- `seq`: the list of conditions applied in the specified order, with any number of events occurring in-between.
- `at_least_once`: the listed marker definitions occurred at least once. Only the first occurrence will be marked.
- `never`: the listed marker definitions never occurred.

### Marker Configuration

Here is an example of a marker configuration file containing several marker definitions. The example is created for mood bot, with a new slot `name` (to illustrate the use of the label `slot_was_set`):

```yaml
marker_name_provided:
    slot_was_set: name
marker_mood_expressed:
    or:
        - intent: mood_unhappy
        - intent: mood_great
marker_cheer_up_failed:
    seq:
        - intent: mood_unhappy
        - action: utter_cheer_up
        - action: utter_did_that_help
        - intent: deny
marker_bot_not_challenged:
    never:
        - intent: bot_challenge
marker_cheer_up_attempt:
    at_least_once:
        - action: utter_cheer_up
marker_mood_expressed_and_name_not_provided:
    and:
        - not:
            - slot_was_set: name
        - or:
            - intent: mood_unhappy
            - intent: mood_great
```
Note the following:

- Each marker has a unique identifier, such as `marker_name_provided`.

- A marker definition can contain a single condition, as shown in `marker_name_provided`.

- Marker definitions can contain a single operator with nested conditions, as shown in `marker_mood_expressed`, `marker_cheer_up_failed`, `marker_bot_not_challenged`, and `marker_cheer_up_attempt`.

- A marker definition can contain nested operators, as shown in `marker_mood_expressed_and_name_not_provided`.

- The values assigned to the event conditions should exist in your bot's `domain.yml` file. For example, in `marker_mood_expressed`, the intents `mood_unhappy` and `mood_unhappy` must exist the mood bot's `domain.yml` file.

:::note
You cannot yet reuse an existing marker name in the definition of another marker.
:::

## Extracting Markers

Markers are extracted from dialogues already stored a tracker store. To learn about how to store conversations with your bot in a tracker store, read the [Tracker Store](https://rasa.com/docs/rasa/next/tracker-stores) page.

Once you've created your Marker definitions in the Markers configuration file, you can extract them by running the following command:

```bash
rasa evaluate markers all --config markers.yml extracted_markers.csv
```

This script will process the marker definitions provided in the `marker.yml` file, and will output the extracted markers in `extracted_markers.csv`.

By default, the script will validate the marker definitions in `marker.yml` against your bot's `domain.yml` file. To specify a different domain filename, use the optional `--domain` argument.

By default, the script will retrieve the tracker store specified in your bot's `endpoint.yml` file. However, you can specify a different endpoint filename using the optional `--endpoint` argument.

The script provides three tracker loading strategies: `all`, `sample_n`, and `first_n`. The option `all` will process all the trackers in your tracker store. The other two strategies process a subset of `N` trackers from all trackers, either sequentially (by using `first_n`) or by sampling uniformly without replacement (by using `sample_n`). The sampling strategy also allows you to set the random seed.
For more information on usage of each strategy, type (replacing `<strategy>` with one of `all`, `first_n`, and `sample_n`):
```bash
rasa evaluate markers <strategy> --help
```

Each tracker in the tracker store can contain multiple sessions. The script will process each session separately, indexing them by `session_idx`.

The script above will output the extracted markers in the `extracted_markers.csv`. It will also compute overall summary statistics and per-session summary statistics and output them in the files `stats-overall.csv` and `stats-per-session.csv`. You can change prefix `stats` in the file names using the optional argument `--stats-file-prefix `. For example, typing:
```bash
rasa evaluate markers all --config markers.yml --stats-file-prefix "marker-statistics" extracted_markers.csv
```
will produce the files: `marker-statistics-overall.csv` and `marker-statistics-per-session.csv`.

The next two sections give more detail about the extracted markers and computed statistics.


### Extracted Markers

For each marker defined in the marker configuration file, the following information is extracted:
1. The number of user turns (i.e., the number of `UserUttered` events) preceding the event at which a marker applied.
2. The index of the event at which a marker applied.

For the `at_least_once` marker, the information above will only be extracted for the first occurrence.

The extracted markers will be output to the `.csv` file you specify in the script, for example, `extracted_markers.csv` (in the script above).
The extracted markers file contains the following columns:

- `sender_id`
- `session_idx`: sessions are indexed starting with `0`.
- `marker name`
- `event_idx`: tracker events are indexed starting with index `0`.
- `num_preceding_user_turns`: the number of user turns which preceded the event at which the marker applied.

Because events contain many system actions, the `num_preceding_user_turns` gives a better indication of how long the dialogue took to reach a point of interest, focussing on the perspective of your end user.

Here is a sample of the extracted markers output file:

```
sender_id,session_idx,marker_name,event_id,num_preceding_user_turns
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,7,1
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,7,1
```

### Computed Statistics

By default, the script computes summary statistics about the information gathered. To disable the statistics computation, use the optional flag `--no-stats`.

The script computes the following statistics:

1. **For each session and each marker**: "per-session statistics" which include the arithmetic mean, median, minimum, and maximum number of user turns preceding the event at which the marker applied.
2. **For all sessions and for each marker**:
    1. overall statistics including the arithmetic mean, median, minimum, and maximum number of user turns preceding the event where the marker applied in any session.
    2. the number of sessions and the percentage of sessions where each marker applied at least once.

The results are stored in tabular format in `stats-overall.csv` and `stats-per-session.csv`.

Here is a sample `stats-per-session.csv` output:

```
sender_id,session_idx,marker,statistic,value
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,count(number of preceding user turns),1
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,count(number of preceding user turns),1
79e7604d2acc442d9f78e00b173786c9,0,marker_mood_expressed,count(number of preceding user turns),0
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,max(number of preceding user turns),1
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,max(number of preceding user turns),1
79e7604d2acc442d9f78e00b173786c9,0,marker_mood_expressed,max(number of preceding user turns),nan
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,mean(number of preceding user turns),1.0
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,mean(number of preceding user turns),1.0
79e7604d2acc442d9f78e00b173786c9,0,marker_mood_expressed,mean(number of preceding user turns),nan
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,median(number of preceding user turns),1.0
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,median(number of preceding user turns),1.0
79e7604d2acc442d9f78e00b173786c9,0,marker_mood_expressed,median(number of preceding user turns),nan
1309ed25d6fa45beb74d0862d37289a5,0,marker_mood_expressed,min(number of preceding user turns),1
2cf4106e76a041dfb2d4f75bd6ae804b,0,marker_mood_expressed,min(number of preceding user turns),1
79e7604d2acc442d9f78e00b173786c9,0,marker_mood_expressed,min(number of preceding user turns),nan
:
```

Here is a sample `stats-overall.csv` output:

```
sender_id,session_idx,marker,statistic,value
all,nan,-,total_number_of_sessions,3
all,nan,marker_cheer_up,number_of_sessions_where_marker_applies_at_least_once,0
all,nan,marker_cheer_up,percentage_of_sessions_where_marker_applies_at_least_once,0.0
all,nan,marker_mood_expressed,number_of_sessions_where_marker_applies_at_least_once,2
all,nan,marker_mood_expressed,percentage_of_sessions_where_marker_applies_at_least_once,66.667
all,nan,marker_mood_expressed_and_name_provided,number_of_sessions_where_marker_applies_at_least_once,0
all,nan,marker_mood_expressed_and_name_provided,percentage_of_sessions_where_marker_applies_at_least_once,0.0
:
```

## Configuring the CLI command

You can configure the marker extraction and statistics computation using the following arguments:

```
usage: rasa evaluate markers [-h] [-v] [-vv] [--quiet] [--config CONFIG] [--no-stats | --stats-file-prefix [STATS_FILE_PREFIX]] [--endpoints ENDPOINTS] [-d DOMAIN] output_filename {first_n,sample,all} ...

positional arguments:
  output_filename       The filename to write the extracted markers to (CSV format).
  {first_n,sample,all}
    first_n             Select trackers sequentially until N are taken.
    sample              Select trackers by sampling N.
    all                 Select all trackers.

optional arguments:
  -h, --help            show this help message and exit
  --config CONFIG       The config file(s) containing marker definitions. This can be a single YAML file, or a directory that contains several files with marker definitions in it. The content of these files will be read and
                        merged together. (default: markers.yml)
  --no-stats            Do not compute summary statistics. (default: True)
  --stats-file-prefix [STATS_FILE_PREFIX]
                        The common file prefix of the files where we write out the compute statistics. More precisely, the file prefix must consist of a common path plus a common file prefix, to which suffixes `-overall.csv` and
                        `-per-session.csv` will be added automatically. (default: stats)
  --endpoints ENDPOINTS
                        Configuration file for the tracker store as a yml file. (default: endpoints.yml)
  -d DOMAIN, --domain DOMAIN
                        Domain specification. This can be a single YAML file, or a directory that contains several files with domain specifications in it. The content of these files will be read and merged together. (default:
                        domain.yml)

Python Logging Options:
  -v, --verbose         Be verbose. Sets logging level to INFO. (default: None)
  -vv, --debug          Print lots of debugging statements. Sets logging level to DEBUG. (default: None)
  --quiet               Be quiet! Sets logging level to WARNING. (default: None)
```